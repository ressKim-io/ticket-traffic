name: PR Check

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Detect which services changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      k8s: ${{ steps.filter.outputs.k8s }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'common/**'
              - 'gateway-service/**'
              - 'auth-service/**'
              - 'game-service/**'
              - 'queue-service/**'
              - 'booking-service/**'
              - 'payment-service/**'
              - 'admin-service/**'
              - 'build.gradle'
              - 'settings.gradle'
            frontend:
              - 'frontend/**'
            k8s:
              - 'infra/k8s/**'
              - 'Dockerfile'
              - 'docker-compose.yml'

  # Backend: lint + test + build
  backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Gradle build (lint + test)
        run: ./gradlew build --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/build/reports/tests/'
          retention-days: 7

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH
          exit-code: 1
          format: sarif
          output: trivy-results.sarif

      - name: Upload Trivy results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif

  # Frontend: lint + type-check + build
  frontend:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npx next lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

  # K8s manifest validation
  k8s-validate:
    needs: changes
    if: needs.changes.outputs.k8s == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubeconform
        run: |
          curl -sL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | \
            tar xz -C /usr/local/bin

      - name: Validate manifests
        run: |
          kubeconform -summary -strict \
            -ignore-filename-pattern 'tls-certificate.yaml' \
            -ignore-filename-pattern 'kustomization.yaml' \
            -skip 'IstioOperator,Kiali,ClusterPolicy,ClusterSecretStore,ExternalSecret,Rollout,AnalysisTemplate,AnalysisRun,ScaledObject,TriggerAuthentication,BackupStorageLocation,VolumeSnapshotLocation,Schedule,PodChaos,NetworkChaos,Workflow,StatusCheck,VerticalPodAutoscaler,Gateway,RequestAuthentication,AuthorizationPolicy,EnvoyFilter,VirtualService,DestinationRule,Sidecar,PeerAuthentication' \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            infra/k8s/

  # Post CI review summary as PR comment
  review-summary:
    needs: [changes, backend, frontend, k8s-validate]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const backendChanged = '${{ needs.changes.outputs.backend }}' === 'true';
            const frontendChanged = '${{ needs.changes.outputs.frontend }}' === 'true';
            const k8sChanged = '${{ needs.changes.outputs.k8s }}' === 'true';

            const backendResult = '${{ needs.backend.result }}';
            const frontendResult = '${{ needs.frontend.result }}';
            const k8sResult = '${{ needs.k8s-validate.result }}';

            function statusEmoji(result, changed) {
              if (!changed) return '⏭️ Skipped';
              if (result === 'success') return '✅ Pass';
              if (result === 'failure') return '❌ Fail';
              if (result === 'cancelled') return '⚠️ Cancelled';
              return '⏭️ Skipped';
            }

            const checks = [
              { name: 'Backend (build/test/security)', changed: backendChanged, result: backendResult },
              { name: 'Frontend (lint/type-check/build)', changed: frontendChanged, result: frontendResult },
              { name: 'K8s Validation (kubeconform)', changed: k8sChanged, result: k8sResult },
            ];

            const rows = checks.map(c =>
              `| ${c.name} | ${statusEmoji(c.result, c.changed)} | ${!c.changed ? 'No changes detected' : '-'} |`
            ).join('\n');

            const hasFailure = checks.some(c => c.changed && c.result === 'failure');
            const verdict = hasFailure
              ? '❌ Some checks failed — please fix before merging'
              : '✅ All checks passed';

            const marker = '<!-- pr-review-summary -->';
            const body = `${marker}\n## CI Review Summary\n\n| Check | Status | Details |\n|-------|--------|--------|\n${rows}\n\n**Result**: ${verdict}\n`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
