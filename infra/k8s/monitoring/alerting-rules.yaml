# PrometheusRule for sportstix alerts
# Requires: prometheus-operator (kube-prometheus-stack)
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: sportstix-alerts
  namespace: sportstix
  labels:
    app.kubernetes.io/part-of: sportstix
    release: prometheus
spec:
  groups:
    - name: sportstix.availability
      rules:
        - alert: HighErrorRate
          expr: >
            sum(rate(http_server_requests_seconds_count{namespace="sportstix",status=~"5.."}[5m])) by (application)
            / sum(rate(http_server_requests_seconds_count{namespace="sportstix"}[5m])) by (application)
            > 0.05
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "High error rate on {{ $labels.application }}"
            description: "{{ $labels.application }} has >5% error rate (current: {{ $value | humanizePercentage }})"

        - alert: HighLatencyP99
          expr: >
            histogram_quantile(0.99,
              sum(rate(http_server_requests_seconds_bucket{namespace="sportstix"}[5m])) by (le, application)
            ) > 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High P99 latency on {{ $labels.application }}"
            description: "{{ $labels.application }} P99 latency >2s (current: {{ $value | humanizeDuration }})"

    - name: sportstix.resources
      rules:
        - alert: HighJVMHeapUsage
          expr: >
            jvm_memory_used_bytes{namespace="sportstix",area="heap"}
            / jvm_memory_max_bytes{namespace="sportstix",area="heap"}
            > 0.85
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High JVM heap usage on {{ $labels.application }}"
            description: "{{ $labels.application }} heap >85% (current: {{ $value | humanizePercentage }})"

        - alert: HikariCPConnectionsExhausted
          expr: >
            hikaricp_connections_pending{namespace="sportstix"} > 5
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "DB connection pool exhausted on {{ $labels.application }}"
            description: "{{ $labels.application }} has {{ $value }} pending connections"

    - name: sportstix.kafka
      rules:
        - alert: KafkaConsumerLagHigh
          expr: >
            sum(kafka_consumer_fetch_manager_records_lag{namespace="sportstix"}) by (application, topic)
            > 10000
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High Kafka consumer lag on {{ $labels.application }}"
            description: "{{ $labels.application }}/{{ $labels.topic }} lag: {{ $value }}"

    - name: sportstix.pods
      rules:
        - alert: PodRestartLoop
          expr: >
            increase(kube_pod_container_status_restarts_total{namespace="sportstix"}[1h]) > 5
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Pod restart loop: {{ $labels.pod }}"
            description: "{{ $labels.pod }} restarted {{ $value }} times in the last hour"

        - alert: PodNotReady
          expr: >
            kube_pod_status_ready{namespace="sportstix",condition="true"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod not ready: {{ $labels.pod }}"
            description: "{{ $labels.pod }} has been not ready for >5 minutes"
