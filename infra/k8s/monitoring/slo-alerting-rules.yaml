# Multi-Burn-Rate SLO Alerts (Google SRE Chapter 6)
# Burn rate = actual error rate / error budget rate
# Budget consumption thresholds trigger page or ticket alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: sportstix-slo-alerts
  namespace: sportstix
  labels:
    app.kubernetes.io/part-of: sportstix
    release: prometheus
spec:
  groups:
    - name: sportstix.slo.burn_rate.availability
      rules:
        # Fast burn: 14.4x burn rate over 1h → 2% budget consumed in 1h
        # Short window (5m) confirms the issue is current
        - alert: SLOAvailabilityFastBurn
          expr: >
            (1 - sli:availability:ratio_rate1h) > (14.4 * (1 - 0.9995))
            and
            (1 - sli:availability:ratio_rate5m) > (14.4 * (1 - 0.9995))
          for: 2m
          labels:
            severity: critical
            slo: availability
            burn_rate: fast
          annotations:
            summary: "SLO: Availability fast burn rate alert"
            description: >
              Availability error budget is being consumed at 14.4x the sustainable rate.
              At this rate, the entire 30-day budget will be exhausted in 2 days.
              1h error rate: {{ with printf `1 - sli:availability:ratio_rate1h` | query }}{{ . | first | value | humanizePercentage }}{{ end }}

        # Slow burn: 6x burn rate over 6h → 5% budget consumed in 6h
        - alert: SLOAvailabilitySlowBurn
          expr: >
            (1 - sli:availability:ratio_rate6h) > (6 * (1 - 0.9995))
            and
            (1 - sli:availability:ratio_rate30m) > (6 * (1 - 0.9995))
          for: 5m
          labels:
            severity: critical
            slo: availability
            burn_rate: slow
          annotations:
            summary: "SLO: Availability slow burn rate alert"
            description: >
              Availability error budget is being consumed at 6x the sustainable rate.
              At this rate, the entire 30-day budget will be exhausted in 5 days.

        # Medium burn: 3x burn rate over 1d → ticket-worthy
        - alert: SLOAvailabilityMediumBurn
          expr: >
            (1 - sli:availability:ratio_rate1d) > (3 * (1 - 0.9995))
            and
            (1 - sli:availability:ratio_rate6h) > (3 * (1 - 0.9995))
          for: 10m
          labels:
            severity: warning
            slo: availability
            burn_rate: medium
          annotations:
            summary: "SLO: Availability medium burn rate alert"
            description: >
              Availability error budget is being consumed at 3x the sustainable rate.
              At this rate, the entire 30-day budget will be exhausted in 10 days.

        # Low burn: 1x burn rate over 3d → informational
        - alert: SLOAvailabilityLowBurn
          expr: >
            (1 - sli:availability:ratio_rate3d) > (1 * (1 - 0.9995))
            and
            (1 - sli:availability:ratio_rate1d) > (1 * (1 - 0.9995))
          for: 30m
          labels:
            severity: warning
            slo: availability
            burn_rate: low
          annotations:
            summary: "SLO: Availability low burn rate alert"
            description: >
              Availability error budget consumption is at the sustainable rate limit.
              Budget remaining: {{ with printf `slo:availability:error_budget_remaining` | query }}{{ . | first | value | humanizePercentage }}{{ end }}

    - name: sportstix.slo.burn_rate.latency
      rules:
        # Fast burn: 14.4x burn rate over 1h
        - alert: SLOLatencyFastBurn
          expr: >
            (1 - sli:latency:good_ratio_rate1h) > (14.4 * (1 - 0.995))
            and
            (1 - sli:latency:good_ratio_rate5m) > (14.4 * (1 - 0.995))
          for: 2m
          labels:
            severity: critical
            slo: latency
            burn_rate: fast
          annotations:
            summary: "SLO: Latency fast burn rate alert"
            description: >
              Latency error budget is being consumed at 14.4x the sustainable rate.
              Over 7.2% of requests are exceeding the 500ms threshold in the last hour.

        # Slow burn: 6x burn rate over 6h
        - alert: SLOLatencySlowBurn
          expr: >
            (1 - sli:latency:good_ratio_rate6h) > (6 * (1 - 0.995))
            and
            (1 - sli:latency:good_ratio_rate30m) > (6 * (1 - 0.995))
          for: 5m
          labels:
            severity: critical
            slo: latency
            burn_rate: slow
          annotations:
            summary: "SLO: Latency slow burn rate alert"
            description: >
              Latency error budget is being consumed at 6x the sustainable rate.
              Over 3% of requests are exceeding the 500ms threshold over 6 hours.

        # Medium burn: 3x burn rate over 1d
        - alert: SLOLatencyMediumBurn
          expr: >
            (1 - sli:latency:good_ratio_rate1d) > (3 * (1 - 0.995))
            and
            (1 - sli:latency:good_ratio_rate6h) > (3 * (1 - 0.995))
          for: 10m
          labels:
            severity: warning
            slo: latency
            burn_rate: medium
          annotations:
            summary: "SLO: Latency medium burn rate alert"
            description: >
              Latency error budget is being consumed at 3x the sustainable rate.

        # Low burn: 1x burn rate over 3d
        - alert: SLOLatencyLowBurn
          expr: >
            (1 - sli:latency:good_ratio_rate3d) > (1 * (1 - 0.995))
            and
            (1 - sli:latency:good_ratio_rate1d) > (1 * (1 - 0.995))
          for: 30m
          labels:
            severity: warning
            slo: latency
            burn_rate: low
          annotations:
            summary: "SLO: Latency low burn rate alert"
            description: >
              Latency error budget consumption is at the sustainable rate limit.
              Budget remaining: {{ with printf `slo:latency:error_budget_remaining` | query }}{{ . | first | value | humanizePercentage }}{{ end }}
