# DestinationRules for sportstix services
# Enhanced circuit breaker + connection pooling + retry for resilience
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: auth
  namespace: sportstix
spec:
  host: auth.sportstix.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 200
        connectTimeout: 3s
      http:
        h2UpgradePolicy: DEFAULT
        maxRequestsPerConnection: 100
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 10s
      baseEjectionTime: 60s
      maxEjectionPercent: 30
---
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: game
  namespace: sportstix
spec:
  host: game.sportstix.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 200
        connectTimeout: 3s
      http:
        h2UpgradePolicy: DEFAULT
        maxRequestsPerConnection: 100
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 10s
      baseEjectionTime: 60s
      maxEjectionPercent: 30
---
# Queue service: WebSocket - DO_NOT_UPGRADE to prevent h2 interference
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: queue
  namespace: sportstix
spec:
  host: queue.sportstix.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 300
        connectTimeout: 3s
      http:
        h2UpgradePolicy: DO_NOT_UPGRADE
        maxRequestsPerConnection: 0
        http1MaxPendingRequests: 200
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 10s
      baseEjectionTime: 60s
      maxEjectionPercent: 30
---
# Booking service: WebSocket - DO_NOT_UPGRADE
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: booking
  namespace: sportstix
spec:
  host: booking.sportstix.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 300
        connectTimeout: 3s
      http:
        h2UpgradePolicy: DO_NOT_UPGRADE
        maxRequestsPerConnection: 0
        http1MaxPendingRequests: 200
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 10s
      baseEjectionTime: 60s
      maxEjectionPercent: 30
  subsets:
    - name: stable
      labels:
        app.kubernetes.io/name: booking
    - name: canary
      labels:
        app.kubernetes.io/name: booking
---
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: payment
  namespace: sportstix
spec:
  host: payment.sportstix.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 200
        connectTimeout: 3s
      http:
        h2UpgradePolicy: DEFAULT
        maxRequestsPerConnection: 100
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 10s
      baseEjectionTime: 60s
      maxEjectionPercent: 30
---
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: admin
  namespace: sportstix
spec:
  host: admin.sportstix.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 3s
      http:
        h2UpgradePolicy: DEFAULT
        maxRequestsPerConnection: 100
        http1MaxPendingRequests: 50
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 10s
      baseEjectionTime: 60s
      maxEjectionPercent: 30
---
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: frontend
  namespace: sportstix
spec:
  host: frontend.sportstix.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 200
        connectTimeout: 3s
      http:
        h2UpgradePolicy: DEFAULT
        maxRequestsPerConnection: 100
        http1MaxPendingRequests: 100
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 10s
      baseEjectionTime: 60s
      maxEjectionPercent: 30
