# ServiceAccount-based access control for east-west traffic
# Istio IngressGateway calls backend services directly

# Backend services: only accept traffic from Istio IngressGateway SA
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-from-ingressgateway
  namespace: sportstix
spec:
  selector:
    matchLabels:
      sportstix.io/tier: backend
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"
    # Allow Prometheus scraping from observability namespace only
    - from:
        - source:
            namespaces: ["observability", "monitoring"]
      to:
        - operation:
            paths: ["/actuator/health/*", "/actuator/prometheus", "/actuator/info"]
---
# Frontend: allow traffic from any source (public-facing)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-frontend-ingress
  namespace: sportstix
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: frontend
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"
