# Authorization policy for JWT-protected routes at IngressGateway
# Public paths allow unauthenticated access, all others require valid JWT
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: require-jwt
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingressgateway
  action: ALLOW
  rules:
    # Public endpoints - no JWT required
    - to:
        - operation:
            paths:
              - "/api/v1/auth/login"
              - "/api/v1/auth/signup"
              - "/api/v1/auth/refresh"
              - "/api/v1/games"
              - "/api/v1/games/*"
              - "/.well-known/jwks.json"
              - "/actuator/health"
              - "/actuator/health/*"
    # All other paths require valid JWT (requestPrincipals populated by RequestAuthentication)
    - from:
        - source:
            requestPrincipals: ["*"]
