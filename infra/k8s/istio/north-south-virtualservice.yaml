# API routing via Istio IngressGateway
# Replaces Spring Cloud Gateway route definitions
# Includes retry policy for resilience against transient failures
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: api-routes
  namespace: sportstix
spec:
  hosts:
    - "api.sportstix.io"
  gateways:
    - sportstix-gateway
  http:
    # JWKS endpoint -> auth service
    - match:
        - uri:
            exact: "/.well-known/jwks.json"
      route:
        - destination:
            host: auth.sportstix.svc.cluster.local
            port:
              number: 8081
      retries: &retries
        attempts: 2
        perTryTimeout: 3s
        retryOn: 5xx,reset,connect-failure,refused-stream
      corsPolicy: &cors
        allowOrigins:
          - exact: "https://sportstix.io"
          - regex: "http://localhost:.*"
        allowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
        allowHeaders:
          - Authorization
          - Content-Type
          - X-Captcha-Token
          - X-Request-Id
        exposeHeaders:
          - Authorization
          - X-Request-Id
        maxAge: 3600s
        allowCredentials: true
    # Auth service
    - match:
        - uri:
            prefix: "/api/v1/auth"
      route:
        - destination:
            host: auth.sportstix.svc.cluster.local
            port:
              number: 8081
      retries: *retries
      corsPolicy: *cors
    # Game service
    - match:
        - uri:
            prefix: "/api/v1/games"
        - uri:
            prefix: "/api/v1/stadiums"
      route:
        - destination:
            host: game.sportstix.svc.cluster.local
            port:
              number: 8082
      retries: *retries
      corsPolicy: *cors
    # Queue service REST
    - match:
        - uri:
            prefix: "/api/v1/queue"
      route:
        - destination:
            host: queue.sportstix.svc.cluster.local
            port:
              number: 8083
      retries: *retries
      corsPolicy: *cors
    # Booking service REST
    - match:
        - uri:
            prefix: "/api/v1/bookings"
      route:
        - destination:
            host: booking.sportstix.svc.cluster.local
            port:
              number: 8084
      retries: *retries
      corsPolicy: *cors
    # Payment service
    - match:
        - uri:
            prefix: "/api/v1/payments"
      route:
        - destination:
            host: payment.sportstix.svc.cluster.local
            port:
              number: 8085
      retries: *retries
      corsPolicy: *cors
    # Admin service
    - match:
        - uri:
            prefix: "/api/v1/admin"
      route:
        - destination:
            host: admin.sportstix.svc.cluster.local
            port:
              number: 8086
      retries: *retries
      corsPolicy: *cors
    # Queue WebSocket (no retries - persistent connection)
    - match:
        - uri:
            prefix: "/ws/queue"
      route:
        - destination:
            host: queue.sportstix.svc.cluster.local
            port:
              number: 8083
      timeout: 0s
    # Booking WebSocket (no retries - persistent connection)
    - match:
        - uri:
            prefix: "/ws/booking"
      route:
        - destination:
            host: booking.sportstix.svc.cluster.local
            port:
              number: 8084
      timeout: 0s
